# Business Central Page Scripting Project - AI Agent Instructions

## Project Purpose
This repository automates Business Central (BC) page testing using YAML-based scripts executed via Playwright. The repository is organized into two main areas:

- **`page-scripting/`** - Script generation and variant automation (PowerShell scripts and project folders)
- **`bc-replay/`** - Test execution and reporting (test runner and utilities)

**Core workflow:** Record a BASE script manually → Generate variants by substituting field values from data files → Test multiple combinations

## Critical Principles

### 1. METHODICAL, GRADUAL APPROACH - MOST IMPORTANT
**NEVER skip steps or jump ahead.** When implementing new features or debugging:
- **ASK before making assumptions** - Don't make up account names, URLs, or credentials
- **ONE small step at a time** - Test each change before adding more
- **VERIFY what works** - Don't add complexity to working solutions
- **PLAN then CHECK** - State your plan, wait for approval, then execute
- **NO improvising** - If you don't have the information, ASK for it
- **COMPARE with working examples** - Use proven patterns as templates

**Example: If testing MFA:**
1. Confirm the actual account details with user
2. Update script with ONLY those details
3. Test and observe behavior
4. Based on results, propose NEXT single step
5. Do NOT create multiple solutions or jump to complex implementations

### 2. Never Improvise BC Actions
**ALWAYS** request reference recordings before implementing new BC actions. The YAML format is generated by BC's page scripting recorder—patterns must match exactly or scripts fail silently.

### 3. Preserve Recorded Patterns
Use recordings as close to those generated by BC's page scripting tool. **Only change specific field values** that are part of your variant strategy (items, locations, vendors). Leave all other YAML structure intact.

### 4. Verify Field Dependencies
Location Code field requires Ship-to option set to "Location" (value: 1) BEFORE it becomes visible. Always verify dependency chain when adding new fields.

### 5. Keep Documentation High-Level
When documenting or explaining processes:
- Focus on what and why, not detailed how-to steps
- Signpost to resources rather than duplicating content
- Use clear, concise language
- Avoid excessive detail—let users discover depth in linked resources

## Repository Structure

**High-level organization only:**

- **`page-scripting/`** - Scripts and automation
  - PowerShell generators (`Generate-BC-Script-Variants.ps1`)
  - Project folders (e.g., `PO Post DirectionsEMEA/`)
  
- **`bc-replay/`** - Test execution
  - Test runner (`npx-run.ps1`)

**Project Folder Convention:**
Each BC process gets its own folder inside `page-scripting/`:
- BASE Recording.yml (tested, working script)
- Data files (Items, Locations, Vendors - plain text, one per line)
- Process.md (business requirements)
- Variants/ (generated scripts)

## Key Workflows

### Generate Variants
```powershell
cd page-scripting
.\Generate-BC-Script-Variants.ps1 `
    -BaseScriptPath ".\ProjectFolder\BASE Recording.yml" `
    -ProjectFolder ".\ProjectFolder" `
    -OutputFolder ".\ProjectFolder\Variants"
```

### Execute Tests
```powershell
cd bc-replay
.\npx-run.ps1
npx playwright show-report
```

## BC-Replay Script Pattern

**CRITICAL:** Always follow the proven working pattern from `npx-run.ps1`:

1. **Prompt for password** securely using `Read-Host -AsSecureString`
2. **Convert to plain text** only in memory
3. **Set environment variables** for credentials
4. **Run `npx replay` immediately** in the same script
5. **Show test report** after completion

**DO NOT:**
- Split credentials and execution into separate scripts
- Add unnecessary validation or checks
- Overcomplicate the simple working pattern
- Store passwords in files

**Example pattern:**
```powershell
# Prompt for password
$securePassword = Read-Host -AsSecureString "Enter password for user@domain.com"
$unsecurePassword = [Runtime.InteropServices.Marshal]::PtrToStringAuto([Runtime.InteropServices.Marshal]::SecureStringToBSTR($securePassword))

# Set credentials
$env:BC_USERNAME = "user@domain.com"
$env:BC_PASSWORD = $unsecurePassword

# Run immediately
npx replay ".\script.yml" `
    -StartAddress "https://businesscentral.dynamics.com/tenant/environment" `
    -Authentication AAD `
    -UserNameKey BC_USERNAME `
    -PasswordKey BC_PASSWORD

# Show report
npx playwright show-report
```

This pattern is proven to work - stick to it!

## Essential YAML Patterns

**Header Field:**
```yaml
- type: input
  target:
    - page: Purchase Order
      runtimeRef: b385
    - field: Buy-from Vendor No.
  value: "1000"
  description: Input <value>1000</value> into <caption>Vendor No.</caption>
```

**Line Entry (Repeater):**
```yaml
- type: focus
  target:
    - page: Purchase Order
      runtimeRef: b385
    - part: PurchLines
    - page: Purchase Order Subform
    - repeater: Control1
    - field: No.
  description: Focus <caption>No.</caption>
- type: input
  target:
    - page: Purchase Order
      runtimeRef: b385
    - part: PurchLines
    - page: Purchase Order Subform
    - repeater: Control1
    - field: No.
  value: "1896-S"
  description: Input <value>1896-S</value> into <caption>No.</caption>
```

**Additional Lines:**
```yaml
- type: set-current-row
  target:
    - page: Purchase Order
      runtimeRef: b385
    - part: PurchLines
    - page: Purchase Order Subform
    - repeater: Control1
  targetRecord:
    relative: 1
  description: Set current row in <caption>Control1</caption>
```

## Quick Validation Checklist

When creating/reviewing scripts:
- [ ] Have reference recording for each action type
- [ ] BASE script tested and works
- [ ] Data files validated against BC test company
- [ ] Field dependencies set correctly
- [ ] Only changed variable fields, not YAML structure

## Common Issues

| Issue | Cause | Fix |
|-------|-------|-----|
| Field not visible | Missing dependency | Set dependencies first |
| Script fails on re-run | Runtime ref changed | Use consistent BASE recording |
| Variant values not substituted | Data file name mismatch | Use expected names: Items, Locations |
| Test data missing | Data doesn't exist in BC | Verify all values exist |

## Testing Strategy

1. Build clean BASE script → Test manually
2. Create single variant → Validate substitution
3. Generate full suite → Only after confirmation
4. Iterate on failures → Fix BASE, regenerate

## Integration Points

- **BC Replay:** Playwright executor in `bc-replay/`
- **BC SaaS:** businesscentral.dynamics.com/{tenant}/{environment}
- **Authentication:** AAD with username/password (MFA disabled for test account)
- **Test Data:** Must pre-exist in BC company
- **Generation:** PowerShell scripts in `page-scripting/`

## When to Ask for Examples

Always request recordings for:
- New field types (dimensions, posting groups)
- New BC actions (approve, print, export)
- New page types (journals, cards, worksheets)
- Debugging unexpected failures

**Always prefer "show me a recording" over "let me try this pattern."**
